# DE0_Nano_Soc_Debian10
This is inspired of the original tutorial from Robert Nelson from Digikey on how to create a Debian 10 sdcard for the DE0-Nano-Soc board and install it on the target.

Link to the original tutorial:

https://www.digikey.com/eewiki/display/linuxonarm/DE0-Nano-SoC+Kit

# How to prepare Debian 10 uSD card for DE0-Nano-Soc

Built on Xubuntu 18.04 64 bits in VMWare Workstation 15 on Intel Core i5 vPro (Virtualization acceleration enabled).

It is OK to build in a virtual machine as long as you have enough RAM and CPU power.

Use the Xubuntu 18.04.1 minimum (this is the one used in this tutorial).

https://xubuntu.org/release/18-04/

## Install compiler
This is a pre-built (64bit) version of Linaro GCC that runs on generic linux, sorry (32bit) x86 users, it's time to upgrade...
Download/Extract:
```
cd ~
wget -c https://releases.linaro.org/components/toolchain/binaries/6.5-2018.12/arm-linux-gnueabihf/gcc-linaro-6.5.0-2018.12-x86_64_arm-linux-gnueabihf.tar.xz
tar xf gcc-linaro-6.5.0-2018.12-x86_64_arm-linux-gnueabihf.tar.xz
export CC=`pwd`/gcc-linaro-6.5.0-2018.12-x86_64_arm-linux-gnueabihf/bin/arm-linux-gnueabihf-
${CC}gcc --version
```
## Build U-boot

Download U-boot source 
```
cd ~
git clone https://github.com/u-boot/u-boot
cd ~/u-boot/
git checkout v2019.07 -b tmp
```
Apply patches:
```
cd ~/u-boot/
wget -c https://github.com/eewiki/u-boot-patches/raw/master/v2019.07/0001-de0_nano-fixes.patch
  
patch -p1 < 0001-de0_nano-fixes.patch
```
Build uboot:
```
cd ~/u-boot/
make ARCH=arm CROSS_COMPILE=${CC} distclean
make ARCH=arm CROSS_COMPILE=${CC} socfpga_de0_nano_soc_defconfig
make ARCH=arm CROSS_COMPILE=${CC} u-boot-with-spl.sfp
```

## Build linux Kernel

```
cd ~
git clone https://github.com/RobertCNelson/socfpga-kernel-dev
cd ~/socfpga-kernel-dev/
git checkout origin/v4.14.x -b tmp
./build_kernel.sh
```
Select the drivers for FPGA and device tree overlays ! 
DMA drivers etc, altera drivers and support for Cyclone 5 FPGA.


## Preparing Debian Root FS

Download and extract the latest minimal debian buster 10.1 root fs.

Default users:password:

1. debian:temppwd
1. root:root 

```
wget -c https://rcn-ee.com/rootfs/eewiki/minfs/debian-10.1-minimal-armhf-2019-09-16.tar.xz
tar xf debian-10.1-minimal-armhf-2019-09-16.tar.xz
```

Ready to install on the SD Card ! 

## Installing the image onto the SD Card

```
cd ~
export DISK=/dev/sdb
export kernel_version=4.14.130-ltsi-socfpga-r2

# install sure ?
echo "Installing on ${DISK}" 

# Script begin
echo "Writing 0s to ${DISK}"

sudo dd if=/dev/zero of=${DISK} bs=1M count=64
echo "Writing 0s done"

echo "Calling SFDISK to format ${DISK}"

sudo sfdisk ${DISK} <<-__EOF__
1M,1M,0xA2,
2M,,,*
__EOF__


echo "Partitionning done !"

#Copy UBOOT to parition 1
echo "Installing Uboot to partition 1"

sudo dd if=./u-boot/u-boot-with-spl.sfp of=${DISK}1

echo "Uboot install done"

#Copy system to partition 2
echo "Formatting and mounting ${DISK} rootfs dir"

sudo mkfs.ext4 -L rootfs ${DISK}2
sudo mkdir -p /media/rootfs/
sudo mount ${DISK}2 /media/rootfs/
echo "Mounting of rootfs done"

#Add root fs
echo "Extracting Rootfs"
sudo tar xfvp ./*-*-*-armhf-*/armhf-rootfs-*.tar -C /media/rootfs/
echo "Syncing to device DONT UNPLUG"
sync
echo "Syncing done"

echo "Setting up rootfs boot section"
sudo chown root:root /media/rootfs/
sudo chmod 755 /media/rootfs/

sudo mkdir -p /media/rootfs/boot/extlinux/
sudo sh -c "echo 'label Linux ${kernel_version}' > /media/rootfs/boot/extlinux/extlinux.conf"
sudo sh -c "echo '    kernel /boot/vmlinuz-${kernel_version}' >> /media/rootfs/boot/extlinux/extlinux.conf"
sudo sh -c "echo '    append root=/dev/mmcblk0p2 ro rootfstype=ext4 rootwait console=ttyS0,115200' >> /media/rootfs/boot/extlinux/extlinux.conf"
sudo sh -c "echo '    fdtdir /boot/dtbs/${kernel_version}/' >> /media/rootfs/boot/extlinux/extlinux.conf"

echo "Copying Kernel files"
sudo cp -v ./socfpga-kernel-dev/deploy/${kernel_version}.zImage /media/rootfs/boot/vmlinuz-${kernel_version}

sudo mkdir -p /media/rootfs/boot/dtbs/${kernel_version}/
sudo tar xfv ./socfpga-kernel-dev/deploy/${kernel_version}-dtbs.tar.gz -C /media/rootfs/boot/dtbs/${kernel_version}/

sudo tar xfv ./socfpga-kernel-dev/deploy/${kernel_version}-modules.tar.gz -C /media/rootfs/

echo "Configuring FSTAB"
sudo sh -c "echo '/dev/mmcblk0p2  /  auto  errors=remount-ro  0  1' >> /media/rootfs/etc/fstab"

echo "Syncing to the device"
sync
echo "Syncing done"
echo "Unmounting rootfs"
sudo umount /media/rootfs

echo "Install DONE"
```

## Boot on the board

### Setup MAC address of the board

After first boot, get the mac address generated by the boot process:

```
ip link

#Returns the following
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: eth0: <BROADCAST,MULTICAST,DYNAMIC,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000
    link/ether ab:56:ef:01:23:45 brd ff:ff:ff:ff:ff:ff
```
	
In this case hte mac address is **ab:56:ef:01:23:45**. 

**Of course you have to replace by your MAC address !**

Restart the board and enter U-Boot console with the serial terminal by interupting boot process.

Once in u-boot console type the following commands to set you MAC address:

```
setenv ethaddr xx:xx:xx:xx:xx:xx
saveenv
reset
```
Now the board will no longer generate new mac addresses on each boot.

### Debian packages cleanup

Start by an update:
```
sudo apt update
```

Packets to remove.
Remove beaglebone capes
```
#Remove any beaglebone overlays (cleans up /lib/firmware dir)
apt remove bb-cape-overlays

#Remove beaglebone customizations 
apt remove bb-customizations

#Remove Nginx server
apt remove nginx nginx-* libnginx*

#Upgrade packages
apt upgrade
```